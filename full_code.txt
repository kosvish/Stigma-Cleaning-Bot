
==================================================
FILE: .\main.py
==================================================

from aiogram import Bot, Dispatcher
from app.config import BOT_TOKEN
from app.handlers.start import router as start_router
from app.handlers.admin import router as admin_router
from app.handlers.create_expenses import router as expense_router
from app.database.base import Base
from app.database.session import engine
from aiogram.fsm.storage.memory import MemoryStorage


def on_startup():
    Base.metadata.create_all(bind=engine)


def main():
    on_startup()

    bot = Bot(token=BOT_TOKEN)
    storage = MemoryStorage()  # ‚Üê –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ—á–∫–∞!
    dp = Dispatcher(storage=storage)
    dp.include_router(start_router)
    dp.include_router(expense_router)
    dp.include_router(admin_router)
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    dp.run_polling(bot)


if __name__ == "__main__":
    main()


==================================================
FILE: .\utiles.py
==================================================

import psutil
import datetime
import os
import speedtest


# –∞–ø—Ç–∞–π–º
def get_uptime():
    boot_time_timestamp = psutil.boot_time()
    boot_time = datetime.datetime.fromtimestamp(boot_time_timestamp)
    current_time = datetime.datetime.now()
    uptime = current_time - boot_time
    hours, remainder = divmod(int(uptime.total_seconds()), 3600)
    minutes, seconds = divmod(remainder, 60)
    return hours, minutes


# CPU
def get_cpu_load():
    return psutil.cpu_percent(interval=1)


# RAM
def get_ram_load():
    ram_info = psutil.virtual_memory()
    return ram_info.percent


# Users
def get_active_users():
    active_users = os.popen('who').readlines()
    return len(active_users)


# Disk I/O
def get_disk_io():
    disk_io = psutil.disk_io_counters(perdisk=False)
    read_gb = round(disk_io.read_bytes / (1024 ** 3), 2)  # –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ì–ë
    write_gb = round(disk_io.write_bytes / (1024 ** 3), 2)  # –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ì–ë
    return read_gb, write_gb


# internet speed
def test_speed():
    try:

        st = speedtest.Speedtest()
        st.get_best_server()
        download_speed = round(st.download() / 1_000_000, 2)  # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ú–±–∏—Ç/—Å –∏ –æ–∫—Ä—É–≥–ª—è–µ–º
        upload_speed = round(st.upload() / 1_000_000, 2)  # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ú–±–∏—Ç/—Å –∏ –æ–∫—Ä—É–≥–ª—è–µ–º
        ping = round(st.results.ping, 2)  # –æ–∫—Ä—É–≥–ª—è–µ–º

        # –ø—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ #  –ò–Ω–æ–≥–¥–∞ speedtest –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É
        if (isinstance(download_speed, (int, float)) and
                isinstance(upload_speed, (int, float)) and
                isinstance(ping, (int, float)) and
                download_speed > 0 and
                upload_speed > 0 and
                ping > 0):
            return download_speed, upload_speed, ping
        else:
            return 0, 0, 0

    except speedtest.ConfigRetrievalError:
        return 0, 0, 0
    except Exception:
        return 0, 0, 0

==================================================
FILE: .\app\config.py
==================================================

import os
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = "sqlite:///db.sqlite3"
WEBAPP_URL = os.getenv("WEBAPP_URL")
GLOBAL_PASSWORD = os.getenv("GLOBAL_PASSWORD")

==================================================
FILE: .\app\database\base.py
==================================================

from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass


==================================================
FILE: .\app\database\session.py
==================================================

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.config import DATABASE_URL

engine = create_engine(
    DATABASE_URL,
    echo=False,
    future=True
)

SessionLocal = sessionmaker(
    bind=engine,
    autoflush=False,
    autocommit=False
)



==================================================
FILE: .\app\database\models\access_key.py
==================================================

from sqlalchemy import String, Boolean, DateTime, Integer
from sqlalchemy.orm import Mapped, mapped_column
from datetime import datetime
from app.database.base import Base

class AccessKey(Base):
    __tablename__ = "access_keys"

    id: Mapped[int] = mapped_column(primary_key=True)
    password: Mapped[str] = mapped_column(String(255))
    role: Mapped[str] = mapped_column(String(20))
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    used_count: Mapped[int] = mapped_column(Integer, default=0)


==================================================
FILE: .\app\database\models\city.py
==================================================

from sqlalchemy import String
from sqlalchemy.orm import Mapped, mapped_column

from app.database.base import Base


class City(Base):
    __tablename__ = "city"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100), unique=True)

==================================================
FILE: .\app\database\models\expense_brand.py
==================================================

from sqlalchemy import String, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.database.base import Base


class ExpenseBrand(Base):
    __tablename__ = "expense_brands"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100))
    category_id: Mapped[int] = mapped_column(
        ForeignKey("expense_categories.id", ondelete="CASCADE")
    )

    category = relationship("ExpenseCategory")


==================================================
FILE: .\app\database\models\expense_category.py
==================================================

from sqlalchemy import String
from sqlalchemy.orm import Mapped, mapped_column

from app.database.base import Base


class ExpenseCategory(Base):
    __tablename__ = "expense_categories"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100), unique=True)


==================================================
FILE: .\app\database\models\expense_subcategory.py
==================================================

from sqlalchemy import String, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.database.base import Base


class ExpenseSubCategory(Base):
    __tablename__ = "expense_subcategories"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100))
    category_id: Mapped[int] = mapped_column(
        ForeignKey("expense_categories.id", ondelete="CASCADE")
    )

    category = relationship("ExpenseCategory")


==================================================
FILE: .\app\database\models\user.py
==================================================

from sqlalchemy import String, Boolean, DateTime
from sqlalchemy.orm import Mapped, mapped_column
from datetime import datetime
from app.database.base import Base


class User(Base):
    __tablename__ = "users"

    id: Mapped[int] = mapped_column(primary_key=True)
    telegram_id: Mapped[int] = mapped_column(unique=True)
    username: Mapped[str | None] = mapped_column(String(50))
    full_name: Mapped[str | None] = mapped_column(String(100))
    role: Mapped[str] = mapped_column(String(20))
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    city: Mapped[str] = mapped_column(String(20), default="–ë–µ–ª–≥–æ—Ä–æ–¥")

==================================================
FILE: .\app\handlers\admin.py
==================================================

from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.types import CallbackQuery

from app.keyboards.admin import admin_main_keyboard, admin_users_keyboard, city_admin_keyboard, cities_list_keyboard
from app.keyboards.manager import manager_main_keyboard
from app.services.cities_service import add_city, get_all_cities, delete_city

from app.services.permissions import user_has_role
from app.states.admin_city import CreateCityFSM
from app.utils.roles import UserRole
from app.utils.callbacks import AdminCallback
from app.services.users_service import (
    get_all_users,
    get_user_by_id,
    delete_user, update_user_city, update_user_role
)
from app.keyboards.admin_users import (
    users_list_keyboard,
    user_actions_keyboard,
    user_edit_keyboard,
    user_city_keyboard,
    user_role_keyboard
)

from app.services.access_keys_service import (
    get_all_keys,
    create_access_key,
    delete_key
)
from app.keyboards.admin_access import (
    admin_access_keyboard,
    access_keys_list_keyboard,
    access_key_actions_keyboard,
    access_roles_keyboard
)
from aiogram.fsm.context import FSMContext
from app.states.admin_access import CreateAccessKeyFSM
from app.services.expense_categories_service import (
    get_all_categories,
    create_category,
    delete_category, get_category_by_id
)
from app.keyboards.admin_categories import (
    categories_main_keyboard,
    categories_list_keyboard
)
from app.states.admin_categories import AdminCategoryFSM
from app.services.expense_subcategories_service import (
    get_subcategories_by_category,
    create_subcategory,
    delete_subcategory
)
from app.keyboards.admin_subcategories import subcategories_list_keyboard
from app.states.admin_subcategories import AdminSubCategoryFSM
from app.services.expense_brands_service import (
    get_brands_by_category,
    create_brand,
    delete_brand
)
from app.keyboards.admin_brands import brands_list_keyboard
from app.states.admin_brands import AdminBrandFSM

router = Router()


@router.message(Command("admin"))
async def admin_panel(message: types.Message):
    if not user_has_role(message.from_user.id, [UserRole.ADMIN]):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return

    await message.answer(
        "üõ† <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=admin_main_keyboard(),
        parse_mode="HTML"
    )


@router.callback_query(AdminCallback.filter(F.role == 'admin'))
async def admin_callbacks(call: CallbackQuery, callback_data: AdminCallback, state: FSMContext):
    action = callback_data.action
    current_state = await state.get_state()
    # –ï—Å–ª–∏ –º—ã –≤ FSM —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
    if current_state == CreateAccessKeyFSM.waiting_for_role.state:
        role = callback_data.value
        data = await state.get_data()
        password = data.get("password")

        create_access_key(password=password, role=role)
        await state.clear()

        await call.message.edit_text(
            f"‚úÖ <b>–ü–∞—Ä–æ–ª—å —Å–æ–∑–¥–∞–Ω</b>\n\n"
            f"–ü–∞—Ä–æ–ª—å: <code>{password}</code>\n"
            f"–†–æ–ª—å: {role}",
            reply_markup=admin_access_keyboard(),
            parse_mode="HTML"
        )
        await call.answer()
        return  # –≤–∞–∂–Ω–æ! —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –∫–æ–¥ admin_callbacks –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    if action == "users":
        await call.message.edit_text(
            "üë§ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</b>\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=admin_users_keyboard(),
            parse_mode="HTML"
        )

    # –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    elif action == "back":
        print(user_has_role(call.from_user.id, [UserRole.MANAGER]))
        print(user_has_role(call.from_user.id, [UserRole.ADMIN]))
        if user_has_role(call.from_user.id, [UserRole.ADMIN]):
            await call.message.edit_text(
                "üõ† <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=admin_main_keyboard(),
                parse_mode="HTML"
            )
        elif user_has_role(call.from_user.id, [UserRole.MANAGER]):
            await call.message.answer(
                "üõ† <b>–ú–µ–Ω–µ–¥–∂–µ—Ä-–ø–∞–Ω–µ–ª—å</b>\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=manager_main_keyboard(),
                parse_mode="HTML"
            )

    # –ó–∞–≥–ª—É—à–∫–∏ (–ø–æ–∫–∞)
    elif action == "users_list":
        users = get_all_users()

        if not users:
            await call.message.edit_text(
                "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
                reply_markup=admin_users_keyboard(),
                parse_mode="HTML"
            )
            return

        await call.message.edit_text(
            "üë§ <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</b>\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
            reply_markup=users_list_keyboard(users),
            parse_mode="HTML"
        )
    elif action == "user_view":
        user = get_user_by_id(callback_data.user_id)

        if not user:
            await call.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
            return

        await call.message.edit_text(
            f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>\n\n"
            f"–ò–º—è: {user.full_name}\n"
            f"Username: @{user.username}\n"
            f"–†–æ–ª—å: {user.role}\n"
            f"–ì–æ—Ä–æ–¥: {user.city}\n"
            f"ID: {user.telegram_id}",
            reply_markup=user_actions_keyboard(user.telegram_id),
            parse_mode="HTML"
        )


    elif action == "user_delete":
        success = delete_user(callback_data.user_id)
        if success:
            await call.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω")
        else:
            await call.answer("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", show_alert=True)

        users = get_all_users()
        await call.message.edit_text(
            "üë§ <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</b>",
            reply_markup=users_list_keyboard(users),
            parse_mode="HTML"
        )

    elif action == "user_edit":
        user = get_user_by_id(callback_data.user_id)

        await call.message.edit_text(
            f"‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n"
            f"–ò–º—è: {user.full_name}\n"
            f"–†–æ–ª—å: {user.role}\n"
            f"–ì–æ—Ä–æ–¥: {user.city}",
            reply_markup=user_edit_keyboard(user.telegram_id),
            parse_mode="HTML"
        )

    elif action == "user_change_city":
        await call.message.edit_text(
            "üèô <b>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</b>",
            reply_markup=user_city_keyboard(callback_data.user_id),
            parse_mode="HTML"
        )

    elif action == "user_set_city":
        update_user_city(callback_data.user_id, callback_data.value)
        await call.answer("–ì–æ—Ä–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        await call.message.edit_text(
            "‚úÖ –ì–æ—Ä–æ–¥ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω",
            reply_markup=user_edit_keyboard(callback_data.user_id)
        )

    elif action == "user_change_role":
        await call.message.edit_text(
            "üß© <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</b>",
            reply_markup=user_role_keyboard(callback_data.user_id),
            parse_mode="HTML"
        )


    elif action == "user_set_role":
        update_user_role(callback_data.user_id, callback_data.value)
        await call.answer("–†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        await call.message.edit_text(
            "‚úÖ –†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞",
            reply_markup=user_edit_keyboard(callback_data.user_id)
        )



    elif action == "access":

        await call.message.edit_text(

            "üîê <b>–î–æ—Å—Ç—É–ø—ã –∏ –ø–∞—Ä–æ–ª–∏</b>",

            reply_markup=admin_access_keyboard(),

            parse_mode="HTML"

        )
    elif action == "access_list":
        keys = get_all_keys()

        await call.message.edit_text(
            "üìã <b>–ü–∞—Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–∞</b>",
            reply_markup=access_keys_list_keyboard(keys),
            parse_mode="HTML"
        )
    elif action == "access_view":
        key_id = int(callback_data.value)

        keys = get_all_keys()
        key = next((k for k in keys if k.id == key_id), None)

        if not key:
            await call.answer("–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
            return

        await call.message.edit_text(
            f"üîê <b>–ü–∞—Ä–æ–ª—å</b>\n\n"
            f"–ó–Ω–∞—á–µ–Ω–∏–µ: <code>{key.password}</code>\n"
            f"–†–æ–ª—å: {key.role}\n"
            f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {key.used_count} —Ä–∞–∑\n"
            f"–ê–∫—Ç–∏–≤–µ–Ω: {'–î–∞' if key.is_active else '–ù–µ—Ç'}",
            reply_markup=access_key_actions_keyboard(key.id),
            parse_mode="HTML"
        )

    elif action == "access_deactivate":
        key_id = int(callback_data.value)
        delete_key(key_id)

        await call.answer("–ü–∞—Ä–æ–ª—å —É–¥–∞–ª—ë–Ω")

        keys = get_all_keys()
        await call.message.edit_text(
            "üìã <b>–ü–∞—Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–∞</b>",
            reply_markup=access_keys_list_keyboard(keys),
            parse_mode="HTML"
        )
    elif action == "access_create":
        await call.message.edit_text(
            "üîê <b>–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:",
            parse_mode="HTML"
        )
        await state.set_state(CreateAccessKeyFSM.waiting_for_password)
    elif action == "categories":
        await call.message.edit_text(
            "üìÇ <b>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
            reply_markup=categories_main_keyboard(),
            parse_mode="HTML"
        )

    # ------------–ö–ê–¢–ï–ì–û–†–ò–ò------------#
    # ------------–ö–ê–¢–ï–ì–û–†–ò–ò------------#
    # ------------–ö–ê–¢–ï–ì–û–†–ò–ò------------#
    elif action == "category_list":
        categories = get_all_categories()

        if not categories:
            await call.message.edit_text(
                "üì¶ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã",
                reply_markup=categories_list_keyboard([]),
                parse_mode="HTML"
            )
            return

        await call.message.edit_text(
            "üì¶ <b>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</b>\n\n"
            "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å:",
            reply_markup=categories_list_keyboard(categories),
            parse_mode="HTML"
        )


    elif action == "category_create":
        await call.message.edit_text(
            "‚ûï <b>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:",
            parse_mode="HTML"
        )
        await state.set_state(AdminCategoryFSM.waiting_for_category_name)

    elif action == "category_delete":
        category_id = int(callback_data.value)
        delete_category(category_id)
        await call.answer("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞")
        categories = get_all_categories()
        await call.message.edit_text(
            "üìÇ <b>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</b>",
            reply_markup=categories_list_keyboard(categories),
            parse_mode="HTML"
        )

    # ------------–ü–û–î–ö–ê–¢–ï–ì–û–†–ò–ò------------#
    # ------------–ü–û–î–ö–ê–¢–ï–ì–û–†–ò–ò------------#
    # ------------–ü–û–î–ö–ê–¢–ï–ì–û–†–ò–ò------------#

    elif action == "subcategory_list":
        category_id = int(callback_data.value)
        category = get_category_by_id(category_id)
        if category:
            subcategories = get_subcategories_by_category(category_id)
            await call.message.edit_text(
                f"üìÇ <b>{category.name}</b>\n\n"
                "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:",
                reply_markup=subcategories_list_keyboard(
                    category_id,
                    category.name,
                    subcategories
                ),
                parse_mode="HTML"
            )
        else:
            await call.answer('–î–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')

    elif action == "subcategory_create":
        category_id = int(callback_data.value)

        await state.update_data(category_id=category_id)
        await call.message.edit_text(
            "‚ûï <b>–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
            parse_mode="HTML"
        )
        await state.set_state(AdminSubCategoryFSM.waiting_for_subcategory_name)


    elif action == "subcategory_delete":
        sub_id = int(callback_data.value)
        delete_subcategory(sub_id)

        await call.answer("–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞")

    # ------------–ë–†–ï–ù–î–´------------#
    elif action == "brand_list":
        category_id = int(callback_data.value)
        brands = get_brands_by_category(category_id)

        await call.message.edit_text(
            "üì¶ <b>–ë—Ä–µ–Ω–¥—ã</b>",
            reply_markup=brands_list_keyboard(category_id, brands),
            parse_mode="HTML"
        )

    elif action == "brand_create":
        category_id = int(callback_data.value)

        await state.update_data(category_id=category_id)
        await call.message.edit_text(
            "‚ûï <b>–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞:",
            parse_mode="HTML"
        )
        await state.set_state(AdminBrandFSM.waiting_for_brand_name)

    elif action == "brand_delete":
        brand_id = int(callback_data.value)
        delete_brand(brand_id)

        await call.answer("–ë—Ä–µ–Ω–¥ —É–¥–∞–ª—ë–Ω")

    elif action == 'city':
        await call.message.edit_text(
            "üèô <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏</b>",
            reply_markup=city_admin_keyboard(),
            parse_mode="HTML"
        )
        await call.answer()
    elif action == 'city_list':
        cities = get_all_cities()

        await call.message.edit_text(
            "üìã <b>–°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤</b>\n\n"
            "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å:",
            reply_markup=cities_list_keyboard(cities),
            parse_mode="HTML"
        )
    elif action == 'city_delete':
        city_id = int(callback_data.value)
        delete_city(city_id)
        await call.answer("–ì–æ—Ä–æ–¥ —É–¥–∞–ª—ë–Ω")
    elif action == "city_add":
        await call.message.edit_text(
            "‚ûï <b>–°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:",
            parse_mode="HTML"
        )
        await state.set_state(CreateCityFSM.waiting_for_city_name)
    await call.answer()


@router.message(CreateCityFSM.waiting_for_city_name)
async def add_city_name(message: types.Message, state: FSMContext):
    name = message.text.strip()

    if not name:
        await message.answer("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return

    add_city(name)

    await state.clear()
    await message.answer(
        f"‚úÖ –ì–æ—Ä–æ–¥ <b>{name}</b> –¥–æ–±–∞–≤–ª–µ–Ω",
        reply_markup=city_admin_keyboard(),
        parse_mode="HTML"
    )
    await state.clear()


@router.message(CreateAccessKeyFSM.waiting_for_password)
async def access_password_input(message: types.Message, state: FSMContext):
    password = message.text.strip()

    if len(password) < 4:
        await message.answer("‚ùå –ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.")
        return

    await state.update_data(password=password)

    await message.answer(
        "üß© –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–∞—Ä–æ–ª—è:",
        reply_markup=access_roles_keyboard(message.from_user.id),
    )

    await state.set_state(CreateAccessKeyFSM.waiting_for_role)


@router.message(AdminCategoryFSM.waiting_for_category_name)
async def category_name_input(message: types.Message, state: FSMContext):
    name = message.text.strip()

    if len(name) < 3:
        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
        return

    success = create_category(name)

    if not success:
        await message.answer("‚ùå –¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        return

    await state.clear()

    categories = get_all_categories()
    await message.answer(
        "‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞",
        reply_markup=categories_list_keyboard(categories)
    )


@router.message(AdminSubCategoryFSM.waiting_for_subcategory_name)
async def subcategory_name_input(message: types.Message, state: FSMContext):
    name = message.text.strip()

    if len(name) < 2:
        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
        return

    data = await state.get_data()
    category_id = data["category_id"]

    success = create_subcategory(category_id, name)

    if not success:
        await message.answer("‚ùå –¢–∞–∫–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        return

    await state.clear()

    subs = get_subcategories_by_category(category_id)
    category = get_category_by_id(category_id)
    await message.answer(
        "‚úÖ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞",
        reply_markup=subcategories_list_keyboard(category_id, category.name, subs)
    )


@router.message(AdminBrandFSM.waiting_for_brand_name)
async def brand_name_input(message: types.Message, state: FSMContext):
    name = message.text.strip()

    if len(name) < 2:
        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
        return

    data = await state.get_data()
    category_id = data["category_id"]

    success = create_brand(category_id, name)
    if not success:
        await message.answer("‚ùå –¢–∞–∫–æ–π –±—Ä–µ–Ω–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        return

    await state.clear()

    brands = get_brands_by_category(category_id)
    await message.answer(
        "‚úÖ –ë—Ä–µ–Ω–¥ –¥–æ–±–∞–≤–ª–µ–Ω",
        reply_markup=brands_list_keyboard(category_id, brands)
    )


==================================================
FILE: .\app\handlers\create_expenses.py
==================================================

from datetime import datetime

import pytz
from aiogram import Router, types, F
from aiogram.types import CallbackQuery
from aiogram.fsm.context import FSMContext

from app.keyboards.admin import admin_main_keyboard
from app.keyboards.create_expense import expense_categories_keyboard, expense_subcategories_keyboard, \
    expense_brands_keyboard, expense_order_ids_keyboard, expense_cities_keyboard, expense_confirm_keyboard
from app.keyboards.manager import manager_main_keyboard
from app.services.cities_service import get_all_cities
from app.services.expense_brands_service import get_brands_by_category
from app.services.expense_categories_service import get_all_categories, get_category_by_id
from app.services.expense_create import expense_type_keyboard
from app.services.expense_subcategories_service import get_subcategories_by_category, get_subcategories_by_id
from app.services.google_sheets_service import get_recent_order_ids, append_expense_to_sheet
from app.services.permissions import user_has_role
from app.services.users_service import get_user_by_id
from app.states.create_expense import CreateExpenseFSM
from app.utils.bot_message_utils import send_and_store, delete_prev_bot_message
from app.utils.callbacks import AdminCallback, ExpenseCallback
from app.utils.text import format_expense_preview

router = Router()


@router.callback_query(ExpenseCallback.filter(F.action == "expense_create"))
async def expense_create_start(call: CallbackQuery, callback_data: AdminCallback, state: FSMContext):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ state (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ª–æ–≥–∏–∫–∏)
    # await state.update_data(user_role=callback_data.role)

    await call.message.edit_text(
        "üí∞ <b>–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å—Ö–æ–¥–∞:",
        reply_markup=expense_type_keyboard(),  # inline –∫–Ω–æ–ø–∫–∏ "–ü—Ä—è–º–æ–π" –∏ "–û–±—â–∏–π"
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_type)
    await call.answer()


@router.callback_query(lambda c: c.data and c.data.startswith("expense_type:"))
async def expense_type_selected(call: CallbackQuery, state: FSMContext):
    expense_type = call.data.split(":")[1]  # direct / general
    expense_value = call.data.split(":")[2]  # direct / general
    categories = get_all_categories()
    await state.update_data(expense_type=expense_type)
    await state.update_data(expense_value=expense_value)

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    await call.message.edit_text(
        "üè∑ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–∞:",
        reply_markup=expense_categories_keyboard(categories),  # inline –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_category)
    await call.answer()


@router.callback_query(ExpenseCallback.filter(F.action == "expense_category_select"))
async def expense_category_selected(call: CallbackQuery, callback_data: ExpenseCallback, state: FSMContext):
    category_id = int(callback_data.value)
    category = get_category_by_id(category_id)
    await state.update_data(category_id=category_id)
    await state.update_data(category=category.name)

    # # –ó–¥–µ—Å—å –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –ë–î –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    subcategories = get_subcategories_by_category(category_id)

    await call.message.edit_text(
        "üìÅ –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=expense_subcategories_keyboard(subcategories),
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_subcategory)
    await call.answer()


@router.callback_query(ExpenseCallback.filter(F.action == "expense_subcategory_select"))
async def expense_subcategory_selected(call: CallbackQuery, callback_data: ExpenseCallback, state: FSMContext):
    subcategory_id = int(callback_data.value)
    subcategory = get_subcategories_by_id(subcategory_id)
    await state.update_data(subcategory_id=subcategory_id, subcategory=subcategory.name)

    # –ü–æ–ª—É—á–∞–µ–º –±—Ä–µ–Ω–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    data = await state.get_data()
    category_id = data.get("category_id")
    brands = get_brands_by_category(category_id)

    await call.message.edit_text(
        "üè∑ –í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥:",
        reply_markup=expense_brands_keyboard(brands),
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_brand)
    await call.answer()


@router.callback_query(ExpenseCallback.filter(F.action == "expense_brand_select"))
async def expense_brand_selected(call: CallbackQuery, callback_data: ExpenseCallback, state: FSMContext):
    if callback_data.value.isnumeric():
        brand_id = int(callback_data.brand_id)
        brands = get_brands_by_category(brand_id)
        index_brand = brands.index(brand_id)
        brand = brands[index_brand]
        await state.update_data(brand_id=brand_id, brand=brand.name)
    else:
        brand_id = 0
        await state.update_data(brand_id=brand_id, brand='-')

    await call.message.edit_text(
        "üî¢ –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–µ–Ω–∏—Ü –ø–æ–∫—É–ø–∫–∏ –∏–ª–∏ —Ç—Ä–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3):",
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_quantity)
    await call.answer()


@router.message(CreateExpenseFSM.waiting_for_quantity)
async def expense_quantity_input(message: types.Message, state: FSMContext):
    try:
        quantity = float(message.text.replace(",", "."))
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        return

    await state.update_data(quantity=quantity)
    await send_and_store(
        message,
        state,
        "‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ (–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ):"
    )
    await state.set_state(CreateExpenseFSM.waiting_for_name)


@router.message(CreateExpenseFSM.waiting_for_name)
async def expense_name_input(message: types.Message, state: FSMContext):
    name = message.text.strip()
    await delete_prev_bot_message(message, state)
    await state.update_data(name=name)
    await send_and_store(
        message,
        state,
        "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Ö–æ–¥–∞:"
    )
    await state.set_state(CreateExpenseFSM.waiting_for_cost)


# --- FSM handler –¥–ª—è –≤–≤–æ–¥–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ---
@router.message(CreateExpenseFSM.waiting_for_cost)
async def expense_price_input(message: types.Message, state: FSMContext):
    try:
        price = float(message.text.replace(",", "."))
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        return
    await delete_prev_bot_message(message, state)
    await state.update_data(cost=price)
    await state.update_data(user_id=message.from_user.id)

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ ID –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ Google Apps Script
    recent_order_ids = get_recent_order_ids(days=3)
    await send_and_store(
        message,
        state,
        "üîó –í—ã–±–µ—Ä–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å / –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤):",
        reply_markup=expense_order_ids_keyboard(recent_order_ids)
    )

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é FSM
    await state.set_state(CreateExpenseFSM.waiting_for_order_id)


@router.callback_query(ExpenseCallback.filter(F.action == "expense_set_order"))
async def expense_order_selected(
    call: CallbackQuery,
    callback_data: ExpenseCallback,
    state: FSMContext
):
    order_id = callback_data.value if callback_data.value != "none" else None
    await state.update_data(order_id=order_id)

    cities = get_all_cities()

    await call.message.edit_text(
        "üèô –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:",
        reply_markup=expense_cities_keyboard(cities)
    )

    await state.set_state(CreateExpenseFSM.waiting_for_city)
    await call.answer()




@router.callback_query(ExpenseCallback.filter(F.action == "expense_set_city"), CreateExpenseFSM.waiting_for_city)
async def expense_city_selected(call: CallbackQuery, callback_data: ExpenseCallback, state: FSMContext):
    await state.update_data(city=callback_data.value)

    data = await state.get_data()
    date = datetime.now().strftime("%d.%m.%Y")
    await state.update_data(date=date)
    await call.message.edit_text(
        "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:",
        reply_markup=expense_confirm_keyboard(data),
        parse_mode="HTML"
    )

    await state.set_state(CreateExpenseFSM.waiting_for_confirm)
    await call.answer()




@router.callback_query(ExpenseCallback.filter(F.action == "confirm_expense"), CreateExpenseFSM.waiting_for_confirm)
async def expense_confirm(call: CallbackQuery, callback_data: ExpenseCallback, state: FSMContext):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞.
    """
    data = await state.get_data()
    user_id = data.get("user_id")
    if callback_data.value == "yes":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Ä–∞—Å—Ö–æ–¥, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Google Sheet
        append_expense_to_sheet(data)
        await call.message.edit_text(
            "‚úÖ –†–∞—Å—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω!",
        )
        if user_has_role(user_id, ['admin']):
            await call.message.answer(f'–í—ã –≤ –ø–∞–Ω–µ–ª–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.',
                                 reply_markup=admin_main_keyboard())
        elif user_has_role(user_id, ['manager']):
            await call.message.answer(f'–í—ã –≤ –ø–∞–Ω–µ–ª–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.',
                                      reply_markup=manager_main_keyboard())
        await state.clear()
        await call.answer()
        return

    elif callback_data.value.startswith("edit_"):
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π
        # –ù–∞–ø—Ä–∏–º–µ—Ä edit_cost, edit_quantity, edit_name, edit_category –∏ —Ç.–¥.
        field_to_edit = callback_data.value.replace("edit_", "")
        edit_handlers_map = {
            "cost": CreateExpenseFSM.waiting_for_cost,
            "quantity": CreateExpenseFSM.waiting_for_quantity,
            "name": CreateExpenseFSM.waiting_for_name,
            "category": CreateExpenseFSM.waiting_for_category,
            "subcategory": CreateExpenseFSM.waiting_for_subcategory,
            "brand": CreateExpenseFSM.waiting_for_brand,
            "order_id": CreateExpenseFSM.waiting_for_order_id,
            "city": CreateExpenseFSM.waiting_for_city
        }

        next_state = edit_handlers_map.get(field_to_edit)
        if next_state:
            await state.set_state(next_state)
        await call.answer()
        return

    # –ï—Å–ª–∏ callback –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
    await call.message.edit_text(
        "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:",
        reply_markup=expense_confirm_keyboard(data),
        parse_mode="HTML"
    )
    await call.answer()





==================================================
FILE: .\app\handlers\manager.py
==================================================

from aiogram import Router, F

from app.keyboards.admin_brands import brands_list_keyboard
from app.keyboards.manager import manager_main_keyboard
from app.services.permissions import user_has_role
from aiogram import Router, types, F

from app.utils.roles import UserRole

router = Router()


==================================================
FILE: .\app\handlers\start.py
==================================================

from aiogram import Router, types
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from app.keyboards.admin import admin_main_keyboard
from app.keyboards.manager import manager_main_keyboard
from app.services.auth_service import authenticate_user, user_exists
from aiogram.filters import Command

from app.services.permissions import user_has_role

router = Router()

class AuthFSM(StatesGroup):
    waiting_for_password = State()

@router.message(Command("start"))
async def start(message: types.Message, state: FSMContext):
    # 8336892245
    if user_exists(message.from_user.id):
        if user_has_role(message.from_user.id, ['admin']):
            await message.answer(f'–° –≤–æ–∑—Ä–∞—â–µ–Ω–∏–µ–º –ê–¥–º–∏–Ω {message.from_user.first_name}', reply_markup=admin_main_keyboard())
        if user_has_role(message.from_user.id, ['manager']):
            await message.answer(f'–° –≤–æ–∑—Ä–∞—â–µ–Ω–∏–µ–º', reply_markup=manager_main_keyboard())
    else:
        await message.answer("üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞")
        await state.set_state(AuthFSM.waiting_for_password)

@router.message(AuthFSM.waiting_for_password)
async def process_password(message: types.Message, state: FSMContext):
    user = authenticate_user(
        telegram_id=message.from_user.id,
        username=message.from_user.username,
        full_name=message.from_user.full_name,
        password=message.text
    )

    if not user:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
        return

    await message.answer("‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω")
    await state.clear()
    if user_has_role(message.from_user.id, ['admin']):
        await start(message, state)
    if user_has_role(message.from_user.id, ['manager']):
        await message.answer(
            "üõ† <b>–ú–µ–Ω–µ–¥–∂–µ—Ä-–ø–∞–Ω–µ–ª—å</b>\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=manager_main_keyboard(),
            parse_mode="HTML"
        )




==================================================
FILE: .\app\keyboards\admin.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback, ExpenseCallback


def admin_main_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
                    callback_data=AdminCallback(action="users", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏",
                    callback_data=AdminCallback(action="categories", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="üîê –î–æ—Å—Ç—É–ø—ã –∏ –ø–∞—Ä–æ–ª–∏",
                    callback_data=AdminCallback(action="access", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="üèôÔ∏è –ì–æ—Ä–æ–¥–∞",
                    callback_data=AdminCallback(action="city", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ûï –ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥",
                    callback_data=ExpenseCallback(action="expense_create").pack()
                )
            ]
        ]
    )


def admin_users_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
                    callback_data=AdminCallback(action="users_list", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ùå –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                    callback_data=AdminCallback(action="users_delete", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=AdminCallback(action="back", role='admin').pack()
                )
            ]
        ]
    )


def city_admin_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="üìã –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤",
                callback_data=AdminCallback(action="city_list", role='admin').pack()
            )
        ],
        [
            InlineKeyboardButton(
                text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥",
                callback_data=AdminCallback(action="city_add", role='admin').pack()
            )
        ],
        [
            InlineKeyboardButton(
                text="‚¨Ö –ù–∞–∑–∞–¥",
                callback_data=AdminCallback(action="back", role='admin').pack()
            )
        ]
    ])


def cities_list_keyboard(cities):
    keyboard = []

    for city in cities:
        keyboard.append([
            InlineKeyboardButton(
                text=f"üèô {city.name}",
                callback_data=AdminCallback(
                    action="city_delete",
                    value=str(city.id),
                    role='admin'
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(action="city", role='admin').pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


==================================================
FILE: .\app\keyboards\admin_access.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback
from app.utils.constants import ROLES


def admin_access_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–æ–ª–∏",
                    callback_data=AdminCallback(action="access_list", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä–æ–ª—å",
                    callback_data=AdminCallback(action="access_create", role='admin').pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=AdminCallback(action="back", role='admin').pack()
                )
            ]
        ]
    )


def access_keys_list_keyboard(keys):
    keyboard = []

    for key in keys:
        status = "üü¢" if key.is_active else "üî¥"
        keyboard.append([
            InlineKeyboardButton(
                text=f"{status} {key.password} ({key.role})",
                callback_data=AdminCallback(
                    action="access_view",
                    value=str(key.id)
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(action="access",  role='admin').pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def access_key_actions_keyboard(key_id: int):
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚ùå –£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–æ–ª—å",
                    callback_data=AdminCallback(
                        action="access_deactivate",
                        value=str(key_id),
                        role='admin'
                    ).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=AdminCallback(action="access_list", role='admin').pack()
                )
            ]
        ]
    )


def access_roles_keyboard(user_id: int):
    keyboard = []

    for role in ROLES:
        cb_data = AdminCallback(
            action="access_set_role",
            user_id=user_id,  # ‚úÖ –ø–µ—Ä–µ–¥–∞—ë–º user_id
            value=role,
            role='admin'
        ).pack()

        keyboard.append([
            InlineKeyboardButton(
                text=role,
                callback_data=cb_data,
                role='admin'
            )
        ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


==================================================
FILE: .\app\keyboards\admin_brands.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback


def brands_list_keyboard(category_id: int, brands):
    keyboard = []

    if brands:
        for brand in brands:
            keyboard.append([
                InlineKeyboardButton(
                    text=f"üóë {brand.name}",
                    callback_data=AdminCallback(
                        action="brand_delete",
                        value=str(brand.id),
                        role='admin'
                    ).pack()
                )
            ])
    else:
        keyboard.append([
            InlineKeyboardButton(
                text="(–±—Ä–µ–Ω–¥–æ–≤ –Ω–µ—Ç)",
                callback_data="noop",
                role='admin'
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –±—Ä–µ–Ω–¥",
            callback_data=AdminCallback(
                action="brand_create",
                value=str(category_id),
                role='admin'
            ).pack()
        )
    ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(
                action="subcategory_list",
                value=str(category_id),
                role='admin'
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


==================================================
FILE: .\app\keyboards\admin_categories.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback


def categories_main_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="üì¶ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤",
            callback_data=AdminCallback(action="category_list", role='admin').pack()
        )],
        [InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(action="back", role='admin').pack()
        )]
    ])


def categories_list_keyboard(categories):
    keyboard = []

    for cat in categories:
        keyboard.append([
            InlineKeyboardButton(
                text=f"üìÇ {cat.name}",
                callback_data=AdminCallback(
                    action="subcategory_list",
                    value=str(cat.id),
                    role='admin'
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚ûï –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é",
            callback_data=AdminCallback(action="category_create", role='admin').pack()
        )
    ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(action="back", role='admin').pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)

==================================================
FILE: .\app\keyboards\admin_subcategories.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback


def subcategories_list_keyboard(category_id: int, category_name: str, subcategories):
    keyboard = []

    if subcategories:
        for sub in subcategories:
            keyboard.append([
                InlineKeyboardButton(
                    text=f"üóë {sub.name}",
                    callback_data=AdminCallback(
                        action="subcategory_delete",
                        value=str(sub.id),
                        role='admin'
                    ).pack()
                )
            ])
    else:
        keyboard.append([
            InlineKeyboardButton(
                text="(–Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π)",
                callback_data="noop",
                role='admin'
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é",
            callback_data=AdminCallback(
                action="subcategory_create",
                value=str(category_id),
                role='admin'
            ).pack()
        )
    ])

    keyboard.append([
        InlineKeyboardButton(
            text="üì¶ –ë—Ä–µ–Ω–¥—ã",
            callback_data=AdminCallback(
                action="brand_list",
                value=str(category_id),
                role='admin'
            ).pack()
        )
    ])

    keyboard.append([
        InlineKeyboardButton(
            text="üóë –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é",
            callback_data=AdminCallback(
                action="category_delete",
                value=str(category_id),
                role='admin'
            ).pack()
        )
    ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(
                action="category_list",
                role='admin'
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


==================================================
FILE: .\app\keyboards\admin_users.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback
from app.database.models.user import User


def users_list_keyboard(users: list[User]):
    keyboard = []

    for user in users:
        keyboard.append([
            InlineKeyboardButton(
                text=f"üë§ {user.full_name} ({user.role}) ({user.city})",
                callback_data=AdminCallback(
                    action="user_view",
                    user_id=user.telegram_id
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(action="back", role='admin').pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def user_actions_keyboard(user_id: int):
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
                    callback_data=AdminCallback(
                        action="user_edit",
                        user_id=user_id
                    ).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚ùå –£–¥–∞–ª–∏—Ç—å",
                    callback_data=AdminCallback(
                        action="user_delete",
                        user_id=user_id
                    ).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=AdminCallback(action="users", role='admin').pack()
                )
            ]
        ]
    )


def user_edit_keyboard(user_id: int):
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üèô –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥",
                    callback_data=AdminCallback(
                        action="user_change_city",
                        user_id=user_id
                    ).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="üß© –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å",
                    callback_data=AdminCallback(
                        action="user_change_role",
                        user_id=user_id
                    ).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=AdminCallback(
                        action="user_view",
                        user_id=user_id,
                        role='admin'
                    ).pack()
                )
            ]
        ]
    )

from app.utils.constants import CITIES

def user_city_keyboard(user_id: int):
    keyboard = []

    for city in CITIES:
        keyboard.append([
            InlineKeyboardButton(
                text=city,
                callback_data=AdminCallback(
                    action="user_set_city",
                    user_id=user_id,
                    value=city
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(
                action="user_edit",
                user_id=user_id,
                role='admin'
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


from app.utils.constants import ROLES

def user_role_keyboard(user_id: int):
    keyboard = []

    for role in ROLES:
        keyboard.append([
            InlineKeyboardButton(
                text=role,
                callback_data=AdminCallback(
                    action="user_set_role",
                    user_id=user_id,
                    value=role
                ).pack()
            )
        ])

    keyboard.append([
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            callback_data=AdminCallback(
                action="user_edit",
                user_id=user_id,
                role='admin'
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


==================================================
FILE: .\app\keyboards\create_expense.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

from app.utils.callbacks import ExpenseCallback


def expense_type_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="–ü—Ä—è–º–æ–π",
                callback_data="expense_type:direct"
            ),
            InlineKeyboardButton(
                text="–û–±—â–∏–π",
                callback_data="expense_type:general"
            )
        ]
    ])


def expense_categories_keyboard(categories):
    """
    –°–æ–∑–¥–∞–µ—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–∞—Å—Ö–æ–¥–∞.
    categories - —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î.
    """
    keyboard = []

    for cat in categories:
        keyboard.append([
            InlineKeyboardButton(
                text=f"üìÇ {cat.name}",
                callback_data=ExpenseCallback(
                    action="expense_category_select",
                    value=str(cat.id)  # –ø–µ—Ä–µ–¥–∞–µ–º id –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                ).pack()
            )
        ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def expense_subcategories_keyboard(subcategories):
    """
    –°–æ–∑–¥–∞–µ—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞—Å—Ö–æ–¥–∞.
    subcategories - —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î.
    """
    keyboard = []

    for sub in subcategories:
        keyboard.append([
            InlineKeyboardButton(
                text=f"üìÅ {sub.name}",
                callback_data=ExpenseCallback(
                    action="expense_subcategory_select",
                    value=str(sub.id)
                ).pack()
            )
        ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def expense_brands_keyboard(brands):
    keyboard = []

    for brand in brands:
        keyboard.append([
            InlineKeyboardButton(
                text=brand.name,
                callback_data=ExpenseCallback(
                    action="expense_brand_select",
                    brand_id=brand.id,
                    value=brand.name
                ).pack()
            )
        ])
    keyboard.append([
        InlineKeyboardButton(
            text='–ù–µ—Ç—É –±—Ä–µ–Ω–¥–∞',
            callback_data=ExpenseCallback(
                action="expense_brand_select",
                value='--'
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton


def expense_order_ids_keyboard(order_ids: list[str]) -> InlineKeyboardMarkup:
    keyboard = []
    for oid in order_ids:
        keyboard.append([
            InlineKeyboardButton(
                text=oid,
                callback_data=ExpenseCallback(
                    action="expense_set_order",
                    value=oid
                ).pack()
            )
        ])
    # –ö–Ω–æ–ø–∫–∞ "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
    keyboard.append([
        InlineKeyboardButton(
            text="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å / –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤",
            callback_data=ExpenseCallback(
                action="expense_set_order",
                value="-"
            ).pack()
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def expense_cities_keyboard(cities):
    keyboard = []

    for city in cities:
        keyboard.append([
            InlineKeyboardButton(
                text=city.name,
                callback_data=ExpenseCallback(
                    action="expense_set_city",
                    value=str(city.name)
                ).pack()
            )
        ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def expense_confirm_keyboard(state_data: dict) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞:
    - –í–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞: ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
    - –ù–∏–∂–µ: –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
    """
    keyboard = []

    # ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard.append([
        InlineKeyboardButton(
            text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
            callback_data=ExpenseCallback(action="confirm_expense", value='yes').pack()
        )
    ])

    # –ü–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    editable_fields = [
        ("cost", "–°—Ç–æ–∏–º–æ—Å—Ç—å"),
        ("quantity", "–ö–æ–ª-–≤–æ"),
        ("category", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"),
        ("subcategory", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è"),
        ("brand", "–ë—Ä–µ–Ω–¥"),
        ("name", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"),
        ("order", "ID –∑–∞–∫–∞–∑–∞"),
        ("city", "–ì–æ—Ä–æ–¥")
    ]

    for field_key, field_label in editable_fields:
        if field_key in state_data:
            display_value = state_data[field_key]
            keyboard.append([
                InlineKeyboardButton(

                    text=f"{field_label}: {display_value}",
                    callback_data=ExpenseCallback(action=f"edit_{field_key}").pack()
                )
            ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)



==================================================
FILE: .\app\keyboards\manager.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from app.utils.callbacks import AdminCallback, ExpenseCallback


def manager_main_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚ûï –ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥",
                    callback_data=ExpenseCallback(action="expense_create").pack()
                )
            ]
        ]
    )

==================================================
FILE: .\app\middlewares\auth.py
==================================================

from aiogram import BaseMiddleware
from app.database.session import SessionLocal
from app.database.models.user import User


class AuthMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data):
        with SessionLocal() as session:
            user = session.query(User).filter(
                User.telegram_id == event.from_user.id
            ).first()

            if not user or not user.is_active:
                await event.answer("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
                return None

        return await handler(event, data)


==================================================
FILE: .\app\services\access_keys_service.py
==================================================

from app.database.session import SessionLocal
from app.database.models.access_key import AccessKey


def get_all_keys():
    with SessionLocal() as session:
        return session.query(AccessKey).all()


def create_access_key(password: str, role: str):
    with SessionLocal() as session:
        key = AccessKey(
            password=password,
            role=role,
            is_active=True,
            used_count=0
        )
        session.add(key)
        session.commit()
        return key


def delete_key(key_id: int):
    with SessionLocal() as session:
        key = session.query(AccessKey).filter(AccessKey.id == key_id).first()
        if not key:
            return False
        session.query(AccessKey).filter(AccessKey.id == key_id).delete()
        session.commit()
        return True


==================================================
FILE: .\app\services\auth_service.py
==================================================

from app.config import GLOBAL_PASSWORD
from app.database.session import SessionLocal
from app.database.models.access_key import AccessKey
from app.database.models.user import User
from app.utils.security import verify_password


def authenticate_user(telegram_id: int, username: str, full_name: str, password: str):
    with SessionLocal() as session:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞
        keys = session.query(AccessKey).filter(AccessKey.is_active == True).all()
        if password == GLOBAL_PASSWORD:
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç
            user = User(
                telegram_id=telegram_id,
                username=username,
                full_name=full_name,
                role="admin"
            )
            session.add(user)
            session.commit()
            return user
        else:
            for key in keys:
                if verify_password(password, key.password):
                    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç
                    user = User(
                        telegram_id=telegram_id,
                        username=username,
                        full_name=full_name,
                        role=key.role
                    )
                    session.add(user)

                    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
                    key.used_count += 1

                    session.commit()
                    return user

        # –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–ª –Ω–∏ —Å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
        return None

def user_exists(telegram_id: int):
    with SessionLocal() as session:
        user = session.query(User).filter(User.telegram_id == telegram_id).first()
        if user:
            return True
        else:
            return False

==================================================
FILE: .\app\services\cities_service.py
==================================================

from app.database.models.city import City
from app.database.session import SessionLocal


def get_all_cities():
    with SessionLocal() as session:
        return session.query(City).all()


def add_city(name: str):
    db = SessionLocal()
    try:
        city = City(name=name)
        db.add(city)
        db.commit()
    finally:
        db.close()

def delete_city(city_id: int):

    db = SessionLocal()
    try:
        db.query(City).filter(City.id == city_id).delete()
        db.commit()
    finally:
        db.close()

==================================================
FILE: .\app\services\expense_brands_service.py
==================================================

from app.database.session import SessionLocal
from app.database.models.expense_brand import ExpenseBrand


def get_brands_by_category(category_id: int):
    with SessionLocal() as session:
        return (
            session.query(ExpenseBrand)
            .filter_by(category_id=category_id)
            .order_by(ExpenseBrand.name)
            .all()
        )


def create_brand(category_id: int, name: str) -> bool:
    with SessionLocal() as session:
        exists = (
            session.query(ExpenseBrand)
            .filter_by(category_id=category_id, name=name)
            .first()
        )
        if exists:
            return False

        brand = ExpenseBrand(
            name=name,
            category_id=category_id
        )
        session.add(brand)
        session.commit()
        return True


def delete_brand(brand_id: int) -> bool:
    with SessionLocal() as session:
        brand = session.get(ExpenseBrand, brand_id)
        if not brand:
            return False

        session.delete(brand)
        session.commit()
        return True

==================================================
FILE: .\app\services\expense_categories_service.py
==================================================

from sqlalchemy.orm import Session
from app.database.session import SessionLocal
from app.database.models.expense_category import ExpenseCategory


def get_all_categories():
    with SessionLocal() as session:
        return session.query(ExpenseCategory).order_by(ExpenseCategory.name).all()


def create_category(name: str) -> bool:
    with SessionLocal() as session:
        exists = session.query(ExpenseCategory).filter_by(name=name).first()
        if exists:
            return False

        category = ExpenseCategory(name=name)
        session.add(category)
        session.commit()
        return True


def delete_category(category_id: int) -> bool:
    with SessionLocal() as session:
        category = session.get(ExpenseCategory, category_id)
        if not category:
            return False

        session.delete(category)
        session.commit()
        return True


def get_category_by_id(category_id: int) -> ExpenseCategory | bool:
    with SessionLocal() as session:
        category = session.query(ExpenseCategory).filter_by(id=category_id).first()
        if category:
            return category
        else:
            return False


==================================================
FILE: .\app\services\expense_create.py
==================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

from app.utils.callbacks import AdminCallback


def expense_type_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="üì¶ –û–±—â–∏–π",
                callback_data="expense_type:general:–û–±—â–∏–π"
            ),
            InlineKeyboardButton(
                text="üéØ –ü—Ä—è–º–æ–π",
                callback_data="expense_type:direct:–ü—Ä—è–º–æ–π"
            ),
            InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                callback_data=AdminCallback(action="back", role='admin').pack()
            )
        ]
    ])


==================================================
FILE: .\app\services\expense_subcategories_service.py
==================================================

from app.database.session import SessionLocal
from app.database.models.expense_subcategory import ExpenseSubCategory


def get_subcategories_by_category(category_id: int):
    with SessionLocal() as session:
        return (
            session.query(ExpenseSubCategory)
            .filter_by(category_id=category_id)
            .order_by(ExpenseSubCategory.name)
            .all()
        )

def get_subcategories_by_id(subcategory_id: int):
    with SessionLocal() as session:
        return (
            session.query(ExpenseSubCategory).filter_by(id=subcategory_id).first()
        )


def create_subcategory(category_id: int, name: str) -> bool:
    with SessionLocal() as session:
        exists = (
            session.query(ExpenseSubCategory)
            .filter_by(category_id=category_id, name=name)
            .first()
        )
        if exists:
            return False

        sub = ExpenseSubCategory(
            name=name,
            category_id=category_id
        )
        session.add(sub)
        session.commit()
        return True


def delete_subcategory(subcategory_id: int) -> bool:
    with SessionLocal() as session:
        sub = session.get(ExpenseSubCategory, subcategory_id)
        if not sub:
            return False

        session.delete(sub)
        session.commit()
        return True


==================================================
FILE: .\app\services\google_sheets_service.py
==================================================

import requests
from datetime import datetime
import pytz

from app.config import WEBAPP_URL

GOOGLE_EXPENSES_URL = "https://script.google.com/macros/s/AKfycbzCNOMJiidv3WW_Tz-8iyXyfI4rfMAn4mSnMesKiV5o4-5oRhWfzKsQUsBjk2GsHxJugA/exec"


def append_expense_to_sheet(data: dict) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Ö–æ–¥ –≤ Google Sheets —á–µ—Ä–µ–∑ GAS
    """
    payload = {
        "date": data.get("date"),
        "type": data.get("expense_value"),
        "category": data.get("category"),
        "subcategory": data.get("subcategory"),
        "brand": data.get("brand"),
        "qty": data.get("quantity"),
        "title": data.get("name"),
        "amount": data.get("cost"),
        "order_id": data.get("order_id") or "",
        "city": data.get("city"),
    }

    try:
        resp = requests.post(
            GOOGLE_EXPENSES_URL,
            json=payload,
            timeout=10
        )

        if resp.status_code == 200:
            result = resp.json()
            return result.get("status") == "ok"

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets:", e)

    return False


def get_recent_order_ids(days: int = 3) -> list[str]:
    try:
        resp = requests.get(WEBAPP_URL, params={"action": "recent_orders", "days": days})
        print(resp.text)
        if resp.status_code == 200:
            return resp.json()  # –°–ø–∏—Å–æ–∫ ID –∑–∞–∫–∞–∑–æ–≤
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∑–∞–∫–∞–∑–æ–≤:", e)
    return []

==================================================
FILE: .\app\services\permissions.py
==================================================

from app.database.session import SessionLocal
from app.database.models.user import User


def user_has_role(telegram_id: int, allowed_roles: list[str]) -> bool:
    with SessionLocal() as session:
        user = session.query(User).filter(
            User.telegram_id == telegram_id
        ).first()

        if not user:
            return False

        return user.role in allowed_roles

==================================================
FILE: .\app\services\users_service.py
==================================================

from app.database.session import SessionLocal
from app.database.models.user import User


def get_all_users():
    with SessionLocal() as session:
        return session.query(User).all()


def get_user_by_id(user_id: int):
    with SessionLocal() as session:
        return session.query(User).filter(User.telegram_id == user_id).first()


def delete_user(user_id: int):
    with SessionLocal() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        if user:
            session.delete(user)
            session.commit()
            return True
        return False


def update_user_city(user_id: int, city: str):
    with SessionLocal() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        if not user:
            return False

        user.city = city
        session.commit()
        return True


def update_user_role(user_id: int, role: str):
    with SessionLocal() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        if not user:
            return False

        user.role = role
        session.commit()
        return True


==================================================
FILE: .\app\states\admin_access.py
==================================================

from aiogram.fsm.state import StatesGroup, State


class CreateAccessKeyFSM(StatesGroup):
    waiting_for_password = State()
    waiting_for_role = State()


==================================================
FILE: .\app\states\admin_brands.py
==================================================

from aiogram.fsm.state import StatesGroup, State


class AdminBrandFSM(StatesGroup):
    waiting_for_brand_name = State()


==================================================
FILE: .\app\states\admin_categories.py
==================================================

from aiogram.fsm.state import StatesGroup, State


class AdminCategoryFSM(StatesGroup):
    waiting_for_category_name = State()


==================================================
FILE: .\app\states\admin_city.py
==================================================

from aiogram.fsm.state import StatesGroup, State


class CreateCityFSM(StatesGroup):
    waiting_for_city_name = State()

==================================================
FILE: .\app\states\admin_subcategories.py
==================================================

from aiogram.fsm.state import StatesGroup, State


class AdminSubCategoryFSM(StatesGroup):
    waiting_for_subcategory_name = State()


==================================================
FILE: .\app\states\create_expense.py
==================================================

from aiogram.fsm.state import StatesGroup, State

class CreateExpenseFSM(StatesGroup):
    waiting_for_type = State()
    waiting_for_category = State()
    waiting_for_subcategory = State()
    waiting_for_brand = State()
    waiting_for_quantity = State()
    waiting_for_name = State()
    waiting_for_cost = State()
    waiting_for_order_id = State()
    waiting_for_city = State()
    waiting_for_confirm = State()


==================================================
FILE: .\app\utils\bot_message_utils.py
==================================================

from aiogram.types import Message
from aiogram.fsm.context import FSMContext

async def delete_prev_bot_message(message: Message, state: FSMContext):
    data = await state.get_data()
    prev_msg_id = data.get("last_bot_message_id")

    if prev_msg_id:
        try:
            await message.bot.delete_message(
                chat_id=message.chat.id,
                message_id=prev_msg_id
            )
        except Exception:
            pass  # —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–æ

async def send_and_store(message: Message, state: FSMContext, text: str, **kwargs):
    sent = await message.answer(text, **kwargs)
    await state.update_data(last_bot_message_id=sent.message_id)



==================================================
FILE: .\app\utils\callbacks.py
==================================================

from aiogram.filters.callback_data import CallbackData


class AdminCallback(CallbackData, prefix="admin"):
    action: str
    user_id: int | None = None
    value: str | None = None
    role: str | None = None


class ExpenseCallback(CallbackData, prefix="expense"):
    action: str
    category_id: int | None = None
    subcategory_id: int | None = None
    brand_id: int | None = None
    value: str | None = None


class ManagerCallback(CallbackData, prefix="manager"):
    action: str
    category_id: int | None = None
    subcategory_id: int | None = None
    brand_id: int | None = None
    value: str | None = None
    role: str | None = 'manager'



def is_admin_or_manager(callback_data: AdminCallback):
    return callback_data.role in ["admin", "manager"]


==================================================
FILE: .\app\utils\constants.py
==================================================

CITIES = [
    "–ë–µ–ª–≥–æ—Ä–æ–¥",
    "–°—Ç–∞—Ä—ã–π –û—Å–∫–æ–ª",
    "–ö—É—Ä—Å–∫"
]

ROLES = [
    "admin",
    "manager",
    "supervisor",
    "cleaner"
]


==================================================
FILE: .\app\utils\roles.py
==================================================

from enum import Enum


class UserRole(str, Enum):
    ADMIN = "admin"
    MANAGER = "manager"
    SUPERVISOR = "supervisor"
    CLEANER = "cleaner"


==================================================
FILE: .\app\utils\security.py
==================================================

from passlib.hash import bcrypt

def hash_password(password: str) -> str:
    return bcrypt.hash(password)

def verify_password(password: str, password_hash: str) -> bool:
    return True if password == password_hash else False


==================================================
FILE: .\app\utils\text.py
==================================================

def format_expense_preview(data: dict) -> str:
    return (
        "üßæ <b>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥–∞</b>\n\n"
        f"üìÖ –î–∞—Ç–∞: <b>{data['date']}</b>\n"
        f"üìå –¢–∏–ø: <b>{data['type']}</b>\n"
        f"üè∑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>{data['category_name']}</b>\n"
        f"üìÅ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: <b>{data['subcategory_name']}</b>\n"
        f"üè≠ –ë—Ä–µ–Ω–¥: <b>{data.get('brand_name', '‚Äî')}</b>\n"
        f"üî¢ –ö–æ–ª-–≤–æ: <b>{data['qty']}</b>\n"
        f"üìù –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: <b>{data['title']}</b>\n"
        f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: <b>{data['price']}</b>\n"
        f"üîó ID –∑–∞–∫–∞–∑–∞: <b>{data.get('order_id', '‚Äî')}</b>\n"
        f"üèô –ì–æ—Ä–æ–¥: <b>{data['city_name']}</b>\n"
    )

